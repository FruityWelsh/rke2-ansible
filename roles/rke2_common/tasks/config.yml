---

- name: Create the /etc/rancher/rke2 config dir
  file:
    path: /etc/rancher/rke2
    state: directory
    recurse: yes

- name: create the /etc/rancher/rke2/config.yaml file
  file:
    path: /etc/rancher/rke2/config.yaml
    state: touch
    mode: "0640"
    owner: root
    group: root


# --node-label value                     (agent/node) Registering and starting kubelet with set of labels
# --node-taint value                     (agent/node) Registering kubelet with set of taints
- name: Combine rke2_config node labels and hostvar node labels
  set_fact:
    all_node_labels: "{{ rke2_config['node-label'] | default([]) }} + {{ node_labels | default([]) }}"

- name: Combine rke2_config node taints and hostvar node taints
  set_fact:
    all_node_taints: "{{ rke2_config['node-taint'] | default([]) }} + {{ node_taints | default([]) }}"

- name: Add node labels to rke2_config
  ansible.utils.update_fact:
    updates:
      - path: rke2_config["node-label"]
        value: "{{ all_node_labels }}"
      - path: rke2_config["node-taint"]
        value: "{{ all_node_taints }}"
  register: updated_rke2_config

- name: Update rke2_config to take value of updated_rke2_config
  set_fact:
    rke2_config: "{{ updated_rke2_config.rke2_config }}"

- name: Preserve previous rke2 config
  block:
      - name: Read previous config to full_orig_rke2_config var
        slurp:
          src: /etc/rancher/rke2/config.yaml
        register: old_rke2_config

        #- name: Format old config to merge with new config data
        #set_fact:
        #   old_rke2_config: "{{ old_rke2_config_raw | b64decode | from_yaml }}"

      - name: Merge variables with existing config
        set_fact:
            rke2_config: "{{ rke2_config | combine( old_rke2_config, recursive=True)  }}"
  when:
      - config_preserve == true

- name: Drop in final /etc/rancher/rke2/config.yaml
  copy:
    content: "{{ rke2_config | to_nice_yaml(indent=0) }}"
    dest: /etc/rancher/rke2/config.yaml
    mode: "0640"
    owner: root
    group: root
